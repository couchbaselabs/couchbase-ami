#!/bin/sh

if [ ! -d /opt/*base ]; then
  cd /home/ec2-user
  rpm -i *base-server-enterprise_x86_64_*.rpm
  /opt/@@PKG_KIND@@/bin/mbenable_core_dumps.sh /tmp
  sleep 3
  /opt/@@PKG_KIND@@/bin/membase cluster-init -c 127.0.0.1 \
    --cluster-init-username=Administrator \
    --cluster-init-password=`curl http://169.254.169.254/latest/meta-data/instance-id`
  sleep 3
  /etc/init.d/@@PKG_KIND@@-server stop
  mkdir -p /mnt/ebs/db
  chown @@PKG_KIND@@:@@PKG_KIND@@ /mnt/ebs/db
  mv /opt/@@PKG_KIND@@/var /mnt/ebs/db
  ln -s /mnt/ebs/db/var /opt/@@PKG_KIND@@/var
  chown -h @@PKG_KIND@@:@@PKG_KIND@@ /opt/@@PKG_KIND@@/var
  /etc/init.d/@@PKG_KIND@@-server start
  rm -f /etc/init/config-pkg.conf
fi

